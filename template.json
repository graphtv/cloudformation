{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Metadata": {
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [ {
				"Label": { "default": "Naming" },
				"Parameters": [ "DomainName", "ValidationEmailDomain", "EnvNamePretty", "EnvNameDNS" ]
			}, {
				"Label": { "default": "Sizing" },
				"Parameters": [ "DynamoWCU", "DynamoRCU" ]
			} ],
			"ParameterLabels": {
				"DomainName": { "default": "Domain Name" },
				"ValidationEmailDomain": { "default": "Validation Email Domain" },
				"EnvNamePretty": { "default": "Pretty Environment Name" },
				"EnvNameDNS": { "default": "DNS-Compliant Environment Name" },
				"DynamoRCU": { "default": "DynamoDB Read Units" },
				"DynamoWCU": { "default": "DynamoDB Write Units" }
			}
		}
	},
	"Parameters": {
		"DomainName": {
			"Type": "String",
			"Default": "",
			"Description": "Domain Name for Route53 Hosted Zone and Static S3 Site"
		},
		"ValidationEmailDomain": {
			"Type": "String",
			"Default": "",
			"Description": "The email domain for ACM to use to send you validation emails. Can be the same as Domain Name or a higher level domain."
		},
		"EnvNamePretty": {
			"Type": "String",
			"Default": "Dev",
			"Description": "Pretty environment designation"
		},
		"EnvNameDNS": {
			"Type": "String",
			"Default": "dev",
			"Description": "DNS-Compliant environment designation"
		},
		"DynamoWCU": {
			"Type": "Number",
			"Default": "5",
			"Description": "Write Capacity Units (1K Writes Per Second)"
		},
		"DynamoRCU": {
			"Type": "Number",
			"Default": "5",
			"Description": "Read Capacity Units (4K Consisent Reads Per Second [x2 for non-consistent])"
		}
	},
	"Resources": {
		"HostedZone": {
			"Type": "AWS::Route53::HostedZone",
			"Properties": {
				"HostedZoneConfig": {
					"Comment": { "Fn::Join": [ "", [ "GraphTV - ", { "Ref": "EnvNamePretty" } ] ] }
				},
				"Name": { "Ref": "DomainName" }
			}
		},
		"CloudFrontAlias": {
			"Type": "AWS::Route53::RecordSet",
			"Properties": {
				"AliasTarget": {
					"DNSName": { "Fn::GetAtt": [ "CloudFront", "DomainName" ] },
					"HostedZoneId": "Z2FDTNDATAQYW2"	
				},
				"Comment": "To CloudFront S3",
				"HostedZoneId": { "Ref": "HostedZone" },
				"Name": { "Fn::Join": [ "", [ { "Ref": "DomainName" }, "." ] ] },
				"Type": "A"
			}
		},
		"Certificate": {
			"Type": "AWS::CertificateManager::Certificate",
			"Properties": {
				"DomainName": { "Ref": "DomainName" },
				"DomainValidationOptions": [ {
					"DomainName": { "Ref": "DomainName" },
					"ValidationDomain": { "Ref": "ValidationEmailDomain" }
				} ],
				"Tags": [ {
					"Key": "Name",
					"Value": { "Fn::Join": [ "", [ "GraphTV - ", { "Ref": "EnvNamePretty" } ] ] }
				} ]
			}
		},
		"CloudFront": {
			"Type": "AWS::CloudFront::Distribution",
			"Properties": {
				"DistributionConfig": {
					"Aliases": [
						{ "Ref": "DomainName" }
					],
					"Comment": { "Fn::Join": [ "", [ "GraphTV - ", { "Ref": "EnvNamePretty" } ] ] },
					"DefaultCacheBehavior": {
						"ForwardedValues": {
							"QueryString": false
						},
						"TargetOriginId": { "Fn::Join": [ "", [ "S3-", { "Ref": "DomainName" } ] ] },
						"ViewerProtocolPolicy": "redirect-to-https"
					},
					"DefaultRootObject": "index.html",
					"Enabled": true,
					"HttpVersion": "http2",
					"Origins": [ {
						"DomainName": { "Fn::Join": [ "", [ { "Ref": "DomainName" }, ".s3.amazonaws.com" ] ] },
						"Id": { "Fn::Join": [ "", [ "S3-", { "Ref": "DomainName" } ] ] },
						"S3OriginConfig": {
							"OriginAccessIdentity": ""
						}
					} ],
					"PriceClass": "PriceClass_100",
					"ViewerCertificate": {
						"AcmCertificateArn": { "Ref": "Certificate" },
						"MinimumProtocolVersion": "TLSv1.1_2016",
						"SslSupportMethod": "sni-only"
					}
				}
			}
		},
		"RatingsDB": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"AttributeDefinitions": [
					{ "AttributeName": "id", "AttributeType": "S" }
				],
				"ProvisionedThroughput": {
					"ReadCapacityUnits": { "Ref": "DynamoRCU" },
					"WriteCapacityUnits": { "Ref": "DynamoWCU" }
				},
				"TableName": { "Fn::Join": [ "", [ "GraphTV-Ratings-", { "Ref": "EnvNamePretty" } ] ] },
				"KeySchema": [
					{ "AttributeName": "id", "KeyType": "HASH" }
				]
			}
		},
		"StaticWebsiteBucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"BucketName": { "Ref": "DomainName" },
				"AccessControl": "PublicRead",
				"WebsiteConfiguration": {
					"IndexDocument": "index.html",
					"ErrorDocument": "error.html"
				}
			},
			"DeletionPolicy": "Retain"
		},
		"StaticWebsiteBucketPolicy": {
			"Type": "AWS::S3::BucketPolicy",
			"Properties": {
				"Bucket": { "Ref": "StaticWebsiteBucket" },
				"PolicyDocument": {
					"Id": "WebAccess",
					"Version": "2012-10-17",
					"Statement": [ {
						"Sid": "PublicReadForGetBucketObjects",
						"Effect": "Allow",
						"Principal": "*",
						"Action": "s3:GetObject",
						"Resource": { "Fn::Join": [ "", [ "arn:aws:s3:::", { "Ref": "StaticWebsiteBucket" }, "/*" ] ] }
					} ]
				}
			}
		},
		"RestAPI": {
			"Type": "AWS::ApiGateway::RestApi",
			"Properties": {
				"Name": { "Fn::Join": [ "", [ "GraphTV-", { "Ref": "EnvNamePretty" } ] ] }
			}
		},
		"APIShows": {
			"Type": "AWS::ApiGateway::Resource",
			"Properties": {
				"RestApiId": { "Ref": "RestAPI" },
				"ParentId": { "Fn::GetAtt": ["RestAPI", "RootResourceId"] },
				"PathPart": "shows"
			}
		},
		"APIShowsShowId": {
			"Type": "AWS::ApiGateway::Resource",
			"Properties": {
				"RestApiId": { "Ref": "RestAPI" },
				"ParentId": { "Ref": "APIShows" },
				"PathPart": "{showId}"
			}
		},
		"APIShowsSearch": {
			"Type": "AWS::ApiGateway::Resource",
			"Properties": {
				"RestApiId": { "Ref": "RestAPI" },
				"ParentId": { "Ref": "APIShows" },
				"PathPart": "search"
			}
		},
		"APIShowsShowIdRatings": {
			"Type": "AWS::ApiGateway::Resource",
			"Properties": {
				"RestApiId": { "Ref": "RestAPI" },
				"ParentId": { "Ref": "APIShowsShowId" },
				"PathPart": "ratings"
			}
		},
		"APIShowsRatings": {
			"Type": "AWS::ApiGateway::Method",
			"Properties": {
				"RestApiId": { "Ref": "RestAPI" },
				"ResourceId": { "Ref": "APIShowsShowIdRatings" },
				"AuthorizationType": "NONE",
				"HttpMethod": "GET",
				"Integration": {
					"Type": "AWS_PROXY",
					"IntegrationHttpMethod": "POST",
					"Uri": { "Fn::Join": [ "", [
						"arn:aws:apigateway:",
						{ "Ref": "AWS::Region"},
						":lambda:path/2015-03-31/functions/arn:aws:lambda:",
						{ "Ref": "AWS::Region"},
						":",
						{ "Ref": "AWS::AccountId" },
						":function:GraphTV-Serverless-",
						{ "Ref": "EnvNamePretty" },
						"-ShowsRatings/invocations"
					] ] }
				}
			}
		}
	},
	"Outputs": {
		"HostedZone": {
			"Description": "Route53 hosted zone name and website hostname.",
			"Value": { "Ref": "DomainName" }
		},
		"NameServers": {
			"Description": "Route53 name servers for the hosted zone.",
			"Value": { "Fn::Join": [ " ", { "Fn::GetAtt": [ "HostedZone", "NameServers" ] } ] }
		}
	}
}
